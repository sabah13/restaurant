<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- Supabase: Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ -->
<script>
  window.SUPABASE_URL  = "https://vlbcsujhgwbqsqcrtpny.supabase.co";   /* Ø¨Ø¯Ù‘Ù„Ù‡Ø§ */
  window.SUPABASE_ANON = "sb_publishable_iGmcWiB4iIvnQRYTfJ0n5A_bpR6jTmI";               /* Ø¨Ø¯Ù‘Ù„Ù‡Ø§ */
</script>

<!-- Ø¹Ù…ÙŠÙ„ Supabase -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
</script>

<!-- Ø¬Ø³Ø± Supabase -->
<script type="module" src="supabase-bridge.js"></script>

<!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„Ø¹Ø§Ù… Ù‚Ø¨Ù„ Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -->
<script type="module">
  import { syncPublicCatalogToLocal } from './supabase-bridge.js';
  await syncPublicCatalogToLocal();
</script>

<!-- Ø§Ù„Ø£Ù‡Ù…: Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ø¯Ù…Ù† + Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† (ØªØ¬Ù„Ø¨ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ù† DB Ø¥Ù„Ù‰ localStorage) -->
<script type="module">
  import { requireAdminOrRedirect, syncAdminDataToLocal } from "./supabase-bridge.js";
  await requireAdminOrRedirect('login.html');   // Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ø£Ø¯Ù…Ù† Ø³ÙŠØ¹ÙŠØ¯Ùƒ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  await syncAdminDataToLocal();
document.dispatchEvent(new Event('sb:admin-synced')); // ğŸ”” Ø£Ø¨Ù„Øº Ø§Ù„ØµÙØ­Ø© Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØµÙ„Øª</script>


  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

 

  <script>
  (function(){
    try{
      var p = new URLSearchParams(location.search);
      if(p.get('embed') === '1'){
        document.documentElement.classList.add('is-embed');
        if(document.body){ document.body.classList.add('is-embed'); }
        else { window.addEventListener('DOMContentLoaded', ()=> document.body.classList.add('is-embed')); }
      }
    }catch(e){}
  })();
  </script>

  <style>
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .nowrap{white-space:nowrap}
    .muted{ color:var(--muted,#6b7280); }
    .input-sm{ height:34px; padding:6px 10px; font-size:.9rem; }

    /* Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© â€” ØµÙÙŠÙ† Ø«Ø§Ø¨ØªÙŠÙ†: 1) ØªØ¨ÙˆÙŠØ¨Ø§Øª  2) Ø£Ø¯ÙˆØ§Øª (Ø¨Ø­Ø« + ØªØ¹Ø§Ø±Ø¶Ø§Øª + Ø¥Ø¶Ø§ÙØ© + ØªØµØ¯ÙŠØ±) */
    .res-head{
      display:grid !important;
      grid-template-columns: 1fr;
      grid-template-rows: auto auto;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
    }
    .res-tabs{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; } /* ÙŠÙ…ÙŠÙ† ÙÙŠ RTL */
    .res-tab{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #eee;background:#fff;cursor:pointer;font-weight:800;box-shadow:var(--shadow)}
    .res-tab.active{background:var(--primary);color:#fff;border-color:transparent}
    .res-tab .count{ background:#f3f4f6; color:#374151; font-weight:900; min-width:34px; text-align:center; padding:4px 10px; border-radius:999px }

    .res-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-start; /* ÙŠÙ…ÙŠÙ† ÙÙŠ RTL */
    }
    .res-search .input{ min-width:260px; }

    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-card{ border:1px solid #eef2f7; border-radius:16px; overflow:hidden; background:#fff; }
    .table-soft{ width:100%; border-collapse:separate; border-spacing:0; }
    .table-soft thead th{
      background:#fff; color:#6b7280; font-weight:800; font-size:.95rem;
      padding:14px 12px; border-bottom:1px solid #eef2f7; text-align:right;
    }
    .table-soft tbody td{
      padding:14px 12px; border-bottom:1px solid #eef2f7; vertical-align:middle;
    }
    .table-soft .col-ops{ width:1%; white-space:nowrap; }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙƒØ¨Ø³ÙˆÙ„Ø§Øª */
    .btn-badge{
      border-radius:999px; padding:8px 12px; font-weight:800; font-size:.9rem; line-height:1; border:1px solid transparent;
      background:#f9fafb; color:#111827;
    }
    .btn-badge:hover{ box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .btn-badge--ghost{ background:#f9fafb; border-color:#e5e7eb; color:#374151; }
    .btn-badge--danger{ background:#fee2e2; border-color:#fecaca; color:#b91c1c; }
    .btn-badge--olive{ background:#ecfccb; border-color:#d9f99d; color:#3f6212; }

    /* ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
    .status-pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 14px; border-radius:999px; font-weight:800; font-size:.9rem; border:1px solid transparent;
    }
    .st-new{       background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
    .st-confirmed{ background:#eff6ff; border-color:#bfdbfe; color:#1d4ed8; }
    .st-seated{    background:#ecfdf5; border-color:#bbf7d0; color:#047857; }
    .st-done{      background:#ecfdf5; border-color:#bbf7d0; color:#047857; }
    .st-canceled{  background:#fef2f2; border-color:#fecaca; color:#b91c1c; }

    /* Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„ØªØ¹Ø§Ø±Ø¶ */
    #resTable tbody tr.is-conflict td{ background:#fff5f5; }

    /* Ø°ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„: Ø§Ù„ØªØµÙØ­ */
    .table-footer{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-top:1px solid #eef2f7; background:#fff;
    }
    .pager{ display:flex; align-items:center; gap:10px; }
    .pager .btn{ border-radius:999px; }
    .page-size{ display:flex; align-items:center; gap:6px; color:#6b7280; }
    .page-size select{ height:32px; border-radius:999px; border:1px solid #e5e7eb; padding:0 10px; background:#fff; }

    /* ÙˆØ¶Ø¹ Ø§Ù„ØªØ¶Ù…ÙŠÙ† */
    body.is-embed .navbar,
    body.is-embed .sidebar,
    body.is-embed #notifDrawer{ display:none !important; }
    body.is-embed .admin-layout{ grid-template-columns: 1fr; }
    body.is-embed .main{ padding:12px; }
    body.is-embed .section.card{ box-shadow:none; border:0; padding:0; }

    /* === ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¨Ø§Ø¹Ø¯ ÙˆØ§Ù„Ø§ØµØ·ÙØ§Ù === */
    .table-soft .col-name{ min-width:160px; }
    .table-soft .col-phone{ min-width:140px; }
    .ops-inline{
      display:flex; align-items:center; gap:8px;
      flex-wrap:nowrap; overflow-x:auto; padding-bottom:2px;
    }
  </style>
</head>
<body>
  <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
  <nav class="navbar">
    <div class="container row">
      <div class="brand">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·Ø¹Ù…</div>
      <div class="nav-actions">
        <button id="logoutBtn" class="btn btn-ghost">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <a href="index.html" class="btn btn-ghost">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
        <button id="refresh" class="btn btn-primary">ØªØ­Ø¯ÙŠØ«</button>
        <div class="icon-btn" id="notifyBtn" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
          <span id="notifCount" class="icon-badge" style="display:none">0</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.4-1.4A2 2 0 0118 14.17V11a6 6 0 00-12 0v3.17a2 2 0 01-.6 1.43L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
        </div>
      </div>
    </div>
  </nav>

  <div class="admin-layout">
    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <aside class="sidebar">
      <h3>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>
      <a class="side-link" href="admin.html">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</a>
      <a class="side-link" href="admin-orders.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
      <a class="side-link" href="admin-menu.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ</a>
      <a class="side-link" href="admin-cats.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
      <a class="side-link" href="admin-ratings.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</a>
      <a class="side-link" href="admin-reports.html">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
      <a class="side-link active" href="admin-reservations.html" aria-current="page">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</a>

      <div class="section">
        <div class="notice small">
          Ù…Ù† Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© ÙˆØ¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†.
        </div>
      </div>
    </aside>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
    <main class="main">
      <!-- KPIs -->
      <section class="kpis">
        <div class="kpi">
          <div class="small" style="margin-bottom:6px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
          <div id="k_all" style="font-weight:900;font-size:24px">0</div>
          <div class="small muted" id="k_all_sub"></div>
        </div>
        <div class="kpi">
          <div class="small" style="margin-bottom:6px">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
          <div id="k_new" style="font-weight:900;font-size:24px">0</div>
          <span class="badge badge-danger small">Ø¬Ø¯ÙŠØ¯</span>
        </div>
        <div class="kpi">
          <div class="small" style="margin-bottom:6px">ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
          <div id="k_confirmed" style="font-weight:900;font-size:24px">0</div>
          <span class="badge badge-olive small">Ù…Ø¤ÙƒØ¯</span>
        </div>
        <div class="kpi">
          <div class="small" style="margin-bottom:6px">Ø§Ù„ÙŠÙˆÙ…</div>
          <div id="k_today" style="font-weight:900;font-size:24px">0</div>
          <div class="small muted">Ø­Ø¬ÙˆØ²Ø§Øª Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
      </section>

      <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
      <section class="section card" style="padding:14px">
        <div class="res-head">
          <div class="res-tabs" role="tablist" aria-label="ØªØµÙÙŠØ© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª">
            <button class="res-tab active" data-tab="all" aria-selected="true"><span class="count" id="ct_all">0</span><span>Ø§Ù„ÙƒÙ„</span></button>
            <button class="res-tab" data-tab="new" aria-selected="false"><span class="count" id="ct_new">0</span><span>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯</span></button>
            <button class="res-tab" data-tab="confirmed" aria-selected="false"><span class="count" id="ct_confirmed">0</span><span>Ù…Ø¤ÙƒØ¯</span></button>
            <button class="res-tab" data-tab="seated" aria-selected="false"><span class="count" id="ct_seated">0</span><span>Ø¬Ø§Ù„Ø³</span></button>
            <button class="res-tab" data-tab="done" aria-selected="false"><span class="count" id="ct_done">0</span><span>Ù…Ù†Ø¬Ø²</span></button>
            <button class="res-tab" data-tab="canceled" aria-selected="false"><span class="count" id="ct_canceled">0</span><span>Ù…Ù„ØºÙŠ</span></button>
          </div>

          <!-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø¨Ø­Ø« + Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª + Ø¥Ø¶Ø§ÙØ© + ØªØµØ¯ÙŠØ± (Ù…Ø­Ø§Ø°Ø§Ø© ÙŠÙ…ÙŠÙ†) -->
          <div class="res-actions">
            <div class="res-search">
              <input id="q" class="input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù‡Ø§ØªÙ / #Ø§Ù„Ù…Ø¹Ø±Ù / Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©" />
            </div>
            <button id="conflictsBtn" class="btn btn-ghost" title="Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª">Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª</button>
            <button id="addBtn" class="btn btn-olive">Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø²</button>
            <button id="exportBtn" class="btn btn-ghost">ØªØµØ¯ÙŠØ± CSV</button>
          </div>
        </div>

        <div class="small muted" style="margin:4px 0 12px">
          ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙƒØ«Ø± Ù…Ù† Ø·Ø§ÙˆÙ„Ø©: <span class="mono">8,9</span> Ø£Ùˆ <span class="mono">3-5</span>. Ø§Ù„ØµÙ Ø§Ù„ÙˆØ±Ø¯ÙŠ ÙŠØ¹Ù†ÙŠ ÙˆØ¬ÙˆØ¯ ØªØ¹Ø§Ø±Ø¶.
        </div>

        <div class="table-card">
          <div class="table-wrap">
            <table class="table-soft" id="resTable" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª">
              <thead>
                <tr>
                  <th class="nowrap">#</th>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„ÙˆÙ‚Øª</th>
                  <th>Ø§Ù„Ø£Ø´Ø®Ø§Øµ</th>
                  <th>Ø·Ø§ÙˆÙ„Ø©</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                  <th class="col-ops">Ø¹Ù…Ù„ÙŠØ§Øª</th>
                </tr>
              </thead>
              <tbody id="resBody"></tbody>
            </table>
          </div>

          <!-- Ø°ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„: Ø§Ù„ØªØµÙØ­ -->
          <div class="table-footer">
            <div class="page-size">
              <select id="pageSize">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
              </select>
              <span>/ ØµÙØ­Ø©</span>
            </div>
            <div class="pager">
              <button class="btn btn-ghost" id="prevPage">Ø§Ù„Ø³Ø§Ø¨Ù‚ â€¹</button>
              <span id="pageInfo" class="mono">1 / 1</span>
              <button class="btn btn-ghost" id="nextPage">â€º Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Ø¯Ø±Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
  <aside class="drawer" id="notifDrawer" aria-hidden="true" style="width:420px">
    <div class="head">
      <strong>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</strong>
      <button class="btn btn-ghost" id="closeNotif">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="body"><div id="notifSummary" class="small" style="margin-bottom:8px;color:var(--muted)"></div><div id="notifList"></div></div>
    <div class="totals">
      <button id="markAllRead" class="btn btn-primary">ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡</button>
    </div>
  </aside>

  <script src="admin.js"></script>
  <script src="admin-multipage.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    try { await window.supabaseBridge?.requireAdminOrRedirect('login.html'); } catch(e){}
    try { await window.supabaseBridge?.syncAdminDataToLocal(); } catch(e){}
    try { updateAll?.(); } catch(e){}
    try { window.dispatchEvent(new Event('storage')); } catch(e){}
  /* ... Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø£Ø³Ø·Ø± 294-296 ... */
  try { renderNotifs?.(); } catch(e){}

  });
</script>

  <script>
  (function(){
    /* ===== Helpers ===== */
    const LS = window.LS || { get:(k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d } catch{ return d } }, set:(k,v)=> localStorage.setItem(k, JSON.stringify(v)) };
    const setText = window.setText || ((sel,v)=>{ const el=document.querySelector(sel); if(el) el.textContent=String(v??''); });

    /* Ø£Ø±Ù‚Ø§Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© */
    const AR_MAP = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
    function toLatn(s){ return String(s).replace(/[Ù -Ù©Û°-Û¹]/g, ch => AR_MAP[ch] ?? ch); }
    const fmtNum = (n)=> new Intl.NumberFormat('en-US').format(Number(n)||0);

    function pad(n){ n=Number(n)||0; return (n<10?'0':'')+n; }
    function splitDateTime(iso){
      if(!iso) return {d:'â€”', t:'â€”'};
      const dt = new Date(iso); if(isNaN(dt)) return {d:'â€”', t:'â€”'};
      const d = pad(dt.getDate()), m = pad(dt.getMonth()+1), y = dt.getFullYear();
      const hh = pad(dt.getHours()), mm = pad(dt.getMinutes());
      return { d: `${d}/${m}/${y}`, t: `${hh}:${mm}` };
    }

    /* ===== Ø·Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© ===== */
    function parseTables(v){
      const s = toLatn((v??'').trim());
      if(!s) return [];
      const tokens = s.split(/[,ØŒ;+/&|\\\s]+/).filter(Boolean);
      const out = [];
      for (let t of tokens){
        t = t.trim();
        const m = t.match(/^(\d+)\s*-\s*(\d+)$/);
        if(m){
          let a = Number(m[1]), b = Number(m[2]);
          if(a>b){ const tmp=a; a=b; b=tmp; }
          for(let i=a;i<=b;i++) out.push(String(i));
        }else{
          out.push(t);
        }
      }
      return [...new Set(out)];
    }
    function formatTables(v){
      const arr = parseTables(v);
      return arr.length? arr.join(', ') : '';
    }
    function intersectTables(a,b){
      const A = parseTables(a), B = parseTables(b);
      return A.filter(x=> B.includes(x));
    }

    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯Ø© */
    function getDefaultDuration(){ return Number(LS.get('res_default_duration', 90)) || 90; }
    function setDefaultDuration(v){ LS.set('res_default_duration', Number(v)||90); }

    /* Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© + ØµÙØ­Ø§Øª */
    const R = { tab:'all', q:'', showConflicts:false, page:1, size: Number(LS.get('res_page_size', 10))||10 };
    let conflictMap = {};

    const statusLabel = (s)=> s==='new'?'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯': s==='confirmed'?'Ù…Ø¤ÙƒØ¯': s==='seated'?'Ø¬Ø§Ù„Ø³': s==='done'?'Ù…Ù†Ø¬Ø²':'Ù…Ù„ØºÙŠ';
    const statusClass = (s)=> 'st-' + (s==='new'?'new': s==='confirmed'?'confirmed': s==='seated'?'seated': s==='done'?'done':'canceled');

    /* ØªÙˆØ­ÙŠØ¯ */
    function norm(r){
      if(!r.status) r.status='new';
      /* ØªØ·Ø¨ÙŠØ¹ ØªÙ‡Ø¬Ø¦Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØ© */
      if (r.status === 'cancelled') r.status = 'canceled';
      if(typeof r.people==='string') r.people = Number(toLatn(r.people))||1;
      if(r.iso){ r.date=r.iso; }
      else if(r.date && r.time){
        const dt = new Date(`${r.date}T${r.time}`); if(!isNaN(dt)) r.date = dt.toISOString();
      }else if(r.date && typeof r.date==='string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(r.date)){
        const dt = new Date(r.date); if(!isNaN(dt)) r.date = dt.toISOString();
      }
      return r;
    }

    function listAll(){ return (LS.get('reservations',[])||[]).map(norm); }
    function saveAll(list){ LS.set('reservations', list); try{ updateAll(); }catch(e){} }

    function isSameDay(iso, d=new Date()){
      if(!iso) return false; const t=new Date(iso);
      return t.getFullYear()===d.getFullYear() && t.getMonth()===d.getMonth() && t.getDate()===d.getDate();
    }

    function toLocalInputValue(date){
      if(!(date instanceof Date) || isNaN(date)) return '';
      const off = date.getTimezoneOffset(); const local = new Date(date.getTime() - off*60000);
      return local.toISOString().slice(0,16);
    }

    /* ===== Ø§Ù„ØªØ¹Ø§Ø±Ø¶ (ÙŠØ¯Ø¹Ù… Ø·Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©) ===== */
    function durationOf(r){ return Number(r.duration || getDefaultDuration()) || getDefaultDuration(); }
    function startOf(r){ return new Date(r.date).getTime(); }
    function endOf(r){ return startOf(r) + durationOf(r)*60000; }
    function hasSharedTable(a,b){
      const over = intersectTables(a.table||'', b.table||'');
      return over.length>0;
    }
    function isActiveStatus(r){ return r.status!=='canceled'; }
    function isOverlap(a,b){ const sa=startOf(a),ea=endOf(a),sb=startOf(b),eb=endOf(b); return sa<eb && sb<ea; }
    function computeConflictMap(list){
      const map={}, L=list.slice().filter(r=> parseTables(r.table).length && isActiveStatus(r));
      for(let i=0;i<L.length;i++) for(let j=i+1;j<L.length;j++){
        const a=L[i], b=L[j];
        if(hasSharedTable(a,b) && isOverlap(a,b)){
          (map[a.id] ||= []).push(b);
          (map[b.id] ||= []).push(a);
        }
      }
      return map;
    }
    function conflictsFor(candidate, list, excludeId=null){
      const cand = Object.assign({}, candidate);
      return list.filter(x=> x.id!==excludeId && isActiveStatus(x) && parseTables(x.table).length && hasSharedTable(x, cand) && isOverlap(x, cand));
    }

    function updateKPIs(){
      const all = listAll();
      const today = all.filter(r=> isSameDay(r.date));
      const newC  = all.filter(r=> r.status==='new').length;
      const confC = all.filter(r=> r.status==='confirmed').length;
      setText('#k_all', fmtNum(all.length));
      setText('#k_all_sub', today.length ? (fmtNum(today.length)+' Ø§Ù„ÙŠÙˆÙ…') : 'Ù„Ø§ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…');
      setText('#k_new', fmtNum(newC));
      setText('#k_confirmed', fmtNum(confC));
      setText('#k_today', fmtNum(today.length));
      updateTabCounts();
    }
    function updateTabCounts(){
      const all = listAll();
      const counts = {
        all: all.length,
        new: all.filter(r=>r.status==='new').length,
        confirmed: all.filter(r=>r.status==='confirmed').length,
        seated: all.filter(r=>r.status==='seated').length,
        done: all.filter(r=>r.status==='done').length,
        canceled: all.filter(r=>r.status==='canceled').length,
      };
      ['all','new','confirmed','seated','done','canceled'].forEach(k=>{
        const el=document.getElementById('ct_'+k); if(el) el.textContent=fmtNum(counts[k]||0);
      });
    }

    function matchQuery(r){
      const q=(R.q||'').trim(); if(!q) return true;
      const qL=toLatn(q);
      if(('#'+String(r.id)).includes(qL)) return true;
      if((r.name||'').includes(q)) return true;
      if(toLatn(r.phone||'').includes(qL)) return true;
      const tStr = formatTables(r.table||'');
      if(tStr.includes(qL)) return true;
      return false;
    }

    /* ====== Render + Pagination ====== */
    function render(){
      updateKPIs();

      // Ø§Ù„Ù‚Ø§Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠØŒ ÙˆØ¯Ø§Ø®Ù„ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ØªØ±ØªÙŠØ¨ Ø²Ù…Ù†ÙŠ ØªØµØ§Ø¹Ø¯ÙŠ
      const now = Date.now();
      const allRecords = listAll().sort((a,b)=>{
        const ta = new Date(a.date).getTime() - now;
        const tb = new Date(b.date).getTime() - now;
        const aFuture = ta >= 0, bFuture = tb >= 0;
        if (aFuture !== bFuture) return aFuture ? -1 : 1; // Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹
        return new Date(a.date) - new Date(b.date);       // Ø«Ù… ØªØ±ØªÙŠØ¨ Ø²Ù…Ù†ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
      });
      const fullConflictMap = computeConflictMap(allRecords);

      const baseFiltered = allRecords
        .filter(r => R.tab==='all' ? true : r.status===R.tab)
        .filter(matchQuery);

      const conflictsCount = baseFiltered.filter(r => (fullConflictMap[r.id]||[]).length>0).length;

      let filtered = R.showConflicts
        ? baseFiltered.filter(r => (fullConflictMap[r.id]||[]).length>0)
        : baseFiltered;

      conflictMap = fullConflictMap;

      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª
      const confBtn = document.getElementById('conflictsBtn');
      if (confBtn) {
        const hasConflicts = conflictsCount > 0;
        confBtn.className = 'btn ' + (hasConflicts ? 'btn-danger' : 'btn-ghost');
        confBtn.textContent = (R.showConflicts ? 'Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„' : 'Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª') + (hasConflicts ? ' ('+fmtNum(conflictsCount)+')' : '');
        confBtn.title = R.showConflicts ? 'Ø¥Ù„ØºØ§Ø¡ ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„' : (hasConflicts ? 'ÙŠÙˆØ¬Ø¯ ØªØ¹Ø§Ø±Ø¶Ø§Øª' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø§Ø±Ø¶Ø§Øª');
      }

      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / R.size));
      if(R.page>pages) R.page=pages;
      if(R.page<1) R.page=1;
      const start = (R.page-1)*R.size;
      const end = start + R.size;
      const pageRows = filtered.slice(start, end);

      const body = document.getElementById('resBody');
      if(!pageRows.length){
        body.innerHTML = '<tr><td colspan="10" class="small" style="color:var(--muted)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</td></tr>';
      }else{
        body.innerHTML = pageRows.map((r,i)=>{
          const rowNum = start + i + 1;
          const dt = splitDateTime(r.date);
          const notes = r.notes ? r.notes.replace(/</g,'&lt;') : 'â€”';
          const confs = conflictMap[r.id]||[];
          const trCls = confs.length ? ' class="is-conflict"' : '';
          const confTitle = confs.length ? confs.map(c=>{
            const over = intersectTables(r.table||'', c.table||'');
            const s = splitDateTime(c.date);
            return `#${String(c.id).slice(0,6)} â€” Ø·Ø§ÙˆÙ„Ø© ${over.join(', ')} â€” ${s.d} ${s.t}`;
          }).join('\n') : '';
          const trTitle = confTitle ? ` title="${confTitle.replace(/"/g,'&quot;')}"` : '';
          const safeId = JSON.stringify(r.id);
          return `<tr${trCls}${trTitle}>
            <td class="mono">${fmtNum(rowNum)}</td>
            <td class="col-name">${r.name||'-'}</td>
            <td class="nowrap col-phone">${toLatn(r.phone||'-')}</td>
            <td class="nowrap">${dt.d}</td>
            <td class="nowrap">${dt.t}</td>
            <td>${fmtNum(r.people||1)}</td>
            <td>${formatTables(r.table||'') || 'â€”'}</td>
            <td><button class="status-pill ${statusClass(r.status)}" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©" onclick='__res.quickStatus(${safeId})'>${statusLabel(r.status)}</button></td>
            <td>${notes}</td>
            <td class="col-ops">
              <div class="ops-inline">
                <button class="btn-badge btn-badge--danger" onclick='__res.remove(${safeId})'>Ø­Ø°Ù</button>
                <button class="btn-badge btn-badge--ghost" onclick='__res.print(${safeId})'>Ø·Ø¨Ø§Ø¹Ø©</button>
                <button class="btn-badge btn-badge--ghost" onclick='__res.assignTable(${safeId})'>ØªØ¹ÙŠÙŠÙ† Ø·Ø§ÙˆÙ„Ø©</button>
                <button class="btn-badge btn-badge--ghost" onclick='__res.edit(${safeId})'>ØªØ¹Ø¯ÙŠÙ„</button>
              </div>
            </td>
          </tr>`;
        }).join('');
      }

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ pager
      setText('#pageInfo', fmtNum(R.page)+' / '+fmtNum(Math.max(1, Math.ceil(total/R.size))));
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      prevBtn.disabled = (R.page<=1);
      nextBtn.disabled = (R.page>=Math.ceil(total/R.size) || Math.ceil(total/R.size)===0);
    }

  async function changeStatus(id, to){
  try{
    await window.supabaseBridge.updateReservationSB(id, { status: to });
      const ns = LS.get('notifications', []);
    ns.unshift({
      id: crypto.randomUUID(),
      type: 'reservation',
      title: `ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø² #${id}`,
      message: `Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${to}`,
      time: new Date().toISOString(),
      read: false
    });
    LS.set('notifications', ns);
    await window.supabaseBridge.syncAdminDataToLocal();
    render();

  }catch(e){
    Modal?.info?.('ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©','Ø®Ø·Ø£');
  }
}


    function openForm(title, r, onSubmit){
      const html = `
        <div class="app-grid">
          <div><label class="app-label">Ø§Ù„Ø§Ø³Ù…</label><input class="app-input" id="f_name" value="${r?.name||''}"></div>
          <div><label class="app-label">Ø§Ù„Ù‡Ø§ØªÙ</label><input class="app-input" id="f_phone" value="${toLatn(r?.phone||'')}"></div>
          <div><label class="app-label">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label><input class="app-input" id="f_date" type="datetime-local" value="${r?.date? toLocalInputValue(new Date(r.date)):''}"></div>
          <div><label class="app-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ</label><input class="app-input" id="f_people" type="number" min="1" value="${r?.people??2}"></div>
          <div><label class="app-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©/Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª</label><input class="app-input" id="f_table" placeholder="Ù…Ø«Ø§Ù„: 8,9 Ø£Ùˆ 3-5" value="${r?.table?formatTables(r.table):''}"></div>
          <div><label class="app-label">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</label><input class="app-input" id="f_duration" type="number" min="15" step="5" value="${r?.duration ?? getDefaultDuration()}"></div>
          <div><label class="app-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select class="app-input" id="f_status">
              ${['new','confirmed','seated','done','canceled'].map(s=>`<option value="${s}" ${r?.status===s?'selected':''}>${statusLabel(s)}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="app-grid-1" style="margin-top:10px">
          <div><label class="app-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="app-input" id="f_notes" rows="3">${r?.notes??''}</textarea></div>
        </div>
      `;
      showModal({
        title, bodyHTML: html,
        actions: [
          { label:'Ø¥Ù„ØºØ§Ø¡', className:'btn btn-ghost', onClick: hideModal },
          { label:'Ø­ÙØ¸', className:'btn btn-primary', onClick: async ()=>{
              const name   = document.getElementById('f_name').value.trim();
              const phone  = toLatn(document.getElementById('f_phone').value.trim());
              const date   = document.getElementById('f_date').value;
              const people = Number(toLatn(document.getElementById('f_people').value||'2'));
              const table  = (document.getElementById('f_table').value||'').trim();
              const duration = Number(toLatn(document.getElementById('f_duration').value||getDefaultDuration()));
              const status = document.getElementById('f_status').value;
              const notes  = document.getElementById('f_notes').value.trim();
              if(!name || !phone || !date || !people){ showModal({title:'ØªÙ†Ø¨ÙŠÙ‡', bodyHTML:'ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.', actions:[{label:'Ù…ÙˆØ§ÙÙ‚', className:'btn btn-primary', onClick: hideModal}]}); return; }
              const iso = new Date(date).toISOString();
              const list = listAll();
              const candidate = { id: r?.id || 'new', name, phone, date: iso, people, table, duration, status, notes };
              const conflicts = conflictsFor(candidate, list, r?.id || null);
              if(conflicts.length){
                const msg = 'ÙŠÙˆØ¬Ø¯ '+conflicts.length+' ØªØ¹Ø§Ø±Ø¶(Ø§Øª) Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª: '+formatTables(table)+'.\n' + conflicts.map(c=>{
                  const over = intersectTables(candidate.table, c.table);
                  const s = splitDateTime(c.date);
                  return 'â€¢ #'+String(c.id).slice(0,6)+' â€” Ø·Ø§ÙˆÙ„Ø© '+over.join(', ')+' â€” '+s.d+' '+s.t;
                }).join('\n');
                let proceed = await new Promise(resolve=>{
                  showModal({
                    title:'ØªØ¹Ø§Ø±Ø¶Ø§Øª Ù…ÙƒØªØ´ÙØ©',
                    bodyHTML:`<pre style="white-space:pre-wrap;font-family:inherit">${msg}</pre><div class="small muted">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„Ø­ÙØ¸ Ø±ØºÙ… Ø§Ù„ØªØ¹Ø§Ø±Ø¶ØŸ</div>`,
                    actions:[
                      {label:'ØªØ±Ø§Ø¬Ø¹', className:'btn btn-ghost', onClick: ()=>{ hideModal(); resolve(false); }},
                      {label:'Ù…ØªØ§Ø¨Ø¹Ø©', className:'btn btn-primary', onClick: ()=>{ hideModal(); resolve(true); }},
                    ],
                  });
                });
                if(!proceed) return;
              }
              onSubmit({name, phone, date: iso, people, table, status, notes, iso, duration});
              hideModal(); render();
            }
          },
        ],
      });
    }

    // ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø§Ù…Ø©
    window.__res = {
      quickStatus(id){
        const list = listAll(); const r = list.find(x=>x.id===id); if(!r) return;
        const flow=['new','confirmed','seated','done']; const i=flow.indexOf(r.status);
        const next = (i>=0 && i<flow.length-1) ? flow[i+1] : 'done';
        changeStatus(id, next);
      },
      edit(id){
        const list=listAll(); const r=list.find(x=>x.id===id); if(!r) return;
openForm('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²', r, async (data)=>{
  try{
    await window.supabaseBridge.updateReservationSB(r.id, {
      name:data.name, phone:data.phone, date:data.date, people:data.people,
table_no:data.table, duration_minutes:data.duration, status:data.status, notes:data.notes
    });
    await window.supabaseBridge.syncAdminDataToLocal();
    render();
  }catch(e){ Modal?.info?.('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸','Ø®Ø·Ø£'); }
});
      },
      assignTable(id){
        const list=listAll(); const r=list.find(x=>x.id===id); if(!r) return;
        const body = `<label class="app-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©/Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª</label>
                      <input class="app-input" id="tableInp" placeholder="Ù…Ø«Ø§Ù„: 8,9 Ø£Ùˆ 3-5" value="${r.table?formatTables(r.table):''}" autofocus />
                      <div class="small muted" style="margin-top:6px">ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙƒØ«Ø± Ù…Ù† Ø·Ø§ÙˆÙ„Ø© Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„.</div>`;
        showModal({
          title:'ØªØ¹ÙŠÙŠÙ† Ø·Ø§ÙˆÙ„Ø©', bodyHTML:body,
          actions:[
            {label:'Ø¥Ù„ØºØ§Ø¡', className:'btn btn-ghost', onClick: hideModal},
  {label:'Ø­ÙØ¸', className:'btn btn-primary', onClick: async ()=>{
  const n=(document.getElementById('tableInp').value||'').trim();
  const candidate = Object.assign({}, r, { table:n });
  const conflicts = conflictsFor(candidate, list, r.id);
  if(conflicts.length){
    const s=conflicts.map(c=>{
      const over = intersectTables(candidate.table, c.table);
      const dt=splitDateTime(c.date);
      return 'â€¢ #'+String(c.id).slice(0,6)+' â€” Ø·Ø§ÙˆÙ„Ø© '+over.join(', ')+' â€” '+dt.d+' '+dt.t;
    }).join('<br>');
    const proceed = await new Promise(resolve=>{
      showModal({ title:'ØªØ¹Ø§Ø±Ø¶Ø§Øª Ù…ÙƒØªØ´ÙØ©',
        bodyHTML:`<div class="small">ÙˆÙØ¬Ø¯Øª ØªØ¹Ø§Ø±Ø¶Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª:</div><div class="small" style="margin-top:6px">${s}</div>`,
        actions:[{label:'ØªØ±Ø§Ø¬Ø¹', className:'btn btn-ghost', onClick:()=>{hideModal();resolve(false)}},
                 {label:'Ù…ØªØ§Ø¨Ø¹Ø©', className:'btn btn-primary', onClick:()=>{hideModal();resolve(true)}}]
      });
    });
    if(!proceed) return;
  }
  try{
await window.supabaseBridge.updateReservationSB(r.id, { table_no:n });
    await window.supabaseBridge.syncAdminDataToLocal();
    hideModal(); render();
  }catch(e){ Modal?.info?.('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸','Ø®Ø·Ø£'); }
}}]

        });
      },
      print(id){
        const r=listAll().find(x=>x.id===id); if(!r) return;
        const dt=splitDateTime(r.date);

        // Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¥Ù† ÙˆÙØ¬Ø¯
        function pickName(){
          const keys=['site_settings','settings','app_settings','shop','store','restaurant','site_info'];
          for(const k of keys){
            const v = LS.get(k,null);
            if(v){
              if(typeof v==='string' && v.trim()) return v.trim();
              if(typeof v==='object'){
                const n = v.name || v.title || v.site_name || v.restaurant_name || v.store_name;
                if(n) return String(n);
              }
            }
          }
          try{
            const t = (document.querySelector('.brand')?.textContent||'').trim();
            if(t && t!=='Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·Ø¹Ù…') return t;
          }catch(_){}
          return 'Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…';
        }
        const brandName = pickName();

        const esc = s => String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

        const w=window.open('', '_blank', 'width=520,height=740');
        w.document.write(`<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">
          <title>Ø¥ÙŠØµØ§Ù„ Ø­Ø¬Ø² #${esc(r.id)}</title>
          <style>
            @page { margin: 16mm; }
            body{ font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial,'Tajawal',sans-serif; background:#fff; color:#111827; }
            .receipt{ border:2px dashed #e5e7eb; border-radius:16px; padding:18px; }
            .tag{ text-align:right; font-size:22px; font-weight:900; margin:0 0 4px; }
            .brand{ text-align:center; font-size:22px; font-weight:900; margin:6px 0 14px; }
            .pairs{ display:grid; grid-template-columns: 1fr max-content; column-gap:22px; row-gap:10px; align-items:baseline; }
            .value{ font-weight:900; font-size:20px; }
            .label{ color:#6b7280; font-size:18px; }
            .notes{ margin-top:14px; }
            .notes-label{ color:#6b7280; margin-bottom:6px; }
            .notes-value{ font-size:18px; }
            hr{ border:0; border-top:1px solid #f1f5f9; margin:10px 0; }
            .muted{ color:#6b7280 }
          </style>
        </head><body>
          <div class="receipt">
            <div class="tag">Ø¥ÙŠØµØ§Ù„ Ø­Ø¬Ø²</div>
            <div class="brand">${esc(brandName)}</div>

            <div class="pairs">
              <div class="label">Ø§Ù„Ø§Ø³Ù… :</div><div class="value">${esc(r.name||'-')}</div>
              <div class="label">Ø§Ù„Ù‡Ø§ØªÙ :</div><div class="value">${esc(toLatn(r.phone||'-'))}</div>
              <div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ® :</div><div class="value">${esc(dt.d)}</div>
              <div class="label">Ø§Ù„ÙˆÙ‚Øª :</div><div class="value">${esc(dt.t)}</div>
              <div class="label">Ø§Ù„Ø£Ø´Ø®Ø§Øµ :</div><div class="value">${fmtNum(r.people||1)}</div>
              <div class="label">Ø§Ù„Ø·Ø§ÙˆÙ„Ø© :</div><div class="value">${esc(formatTables(r.table||'') || 'â€”')}</div>
              <div class="label">Ø§Ù„Ø­Ø§Ù„Ø© :</div><div class="value">${esc(statusLabel(r.status||'new'))}</div>
            </div>

            <div class="notes">
              <div class="notes-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª :</div>
              <div class="notes-value">${esc(r.notes||'â€”')}</div>
            </div>
          </div>

          <script>window.print();<\/script>
        </body></html>`);
        w.document.close();
      },

async remove(id){
  const ok = await new Promise(resolve=>{
    showModal({ title:'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', bodyHTML:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ',
      actions:[{label:'Ø¥Ù„ØºØ§Ø¡', className:'btn btn-ghost', onClick:()=>{hideModal();resolve(false)}},
               {label:'Ø­Ø°Ù', className:'btn btn-danger', onClick:()=>{hideModal();resolve(true)}}]
    });
  });
  if(!ok) return;
  try{
    await window.supabaseBridge.deleteReservationSB(id);
    await window.supabaseBridge.syncAdminDataToLocal();
    render();
  }catch(e){ Modal?.info?.('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­Ø°Ù','Ø®Ø·Ø£'); }
}

    };

    // ØªØ¨ÙˆÙŠØ¨Ø§Øª + Ø¨Ø­Ø«
    document.querySelectorAll('.res-tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.res-tab').forEach(b=>{ const a=b===btn; b.classList.toggle('active', a); b.setAttribute('aria-selected', a?'true':'false');});
        R.tab = btn.getAttribute('data-tab'); R.page=1; render();
      });
    });
    document.getElementById('q').addEventListener('input', (e)=>{ R.q=e.target.value; R.page=1; render(); });

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¥Ù† ÙˆÙØ¬Ø¯ Ø§Ù„Ø­Ù‚Ù„)
    const defDurInp=document.getElementById('defDur');
    if (defDurInp) {
      defDurInp.value=getDefaultDuration();
      defDurInp.addEventListener('change', ()=>{ setDefaultDuration(defDurInp.value); render(); });
    }

    // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª: ÙŠÙÙ„ØªØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆØ¯Ø§Ù„
    document.getElementById('conflictsBtn').addEventListener('click', ()=>{
      R.showConflicts = !R.showConflicts;
      R.page = 1;
      render();
    });

    // Ø§Ù„ØªØµÙØ­
    const pageSizeSel = document.getElementById('pageSize');
    pageSizeSel.value = String(R.size);
    pageSizeSel.addEventListener('change', ()=>{
      R.size = Number(pageSizeSel.value)||10; LS.set('res_page_size', R.size); R.page=1; render();
    });
    document.getElementById('prevPage').addEventListener('click', ()=>{ if(R.page>1){ R.page--; render(); }});
    document.getElementById('nextPage').addEventListener('click', ()=>{
      const total = listAll().filter(r => R.tab==='all'?true:r.status===R.tab).filter(matchQuery).length;
      const pages = Math.max(1, Math.ceil(total / R.size));
      if(R.page<pages){ R.page++; render(); }
    });

    // Ø¥Ø¶Ø§ÙØ© ÙˆØªØµØ¯ÙŠØ±
 document.getElementById('addBtn').addEventListener('click', ()=>{
  openForm('Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯', { status:'new', people:2, duration:getDefaultDuration() }, async (data)=>{
    try{
const iso = data.iso || (data.date ? new Date(data.date).toISOString() : new Date().toISOString());
      await window.supabaseBridge.createReservationSB({
        name:data.name, phone:data.phone, iso, people:data.people,
        kind:'table', table:data.table||'', notes:data.notes, duration_minutes:data.duration||getDefaultDuration()
      });
      await window.supabaseBridge.syncAdminDataToLocal();
      R.page=1; render();
    }catch(e){ Modal?.info?.('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©','Ø®Ø·Ø£'); }
  });
});

    });
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const rows=[['id','name','phone','date','people','table','status','notes','duration'].join(',')];
      listAll().forEach(r=>{
        rows.push([r.id,(r.name||''),(r.phone||''),(r.date||''),(r.people||0),(r.table||''),(r.status||'new'),(r.notes||''),(r.duration||'')].map(v=>{
          const s=String(v??''); return /[,"\n]/.test(s) ? ('"'+s.replace(/"/g,'""')+'"') : s;
        }).join(','));
      });
      const blob=new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='reservations.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
    });

    // ØªØ­Ø¯ÙŠØ« Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø±
    window.addEventListener('storage', (e)=>{ if(e.key==='reservations') render(); });
document.addEventListener('sb:admin-synced', ()=> render());
if (document.readyState !== 'loading') render();
else document.addEventListener('DOMContentLoaded', render);

    // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
    render();
  </script>

<!-- Fallback Sync: Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ø¶Ù…Ø§Ù† ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… -->
<script>
  (async () => {
    try {
      const LS = window.LS || { get:(k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d } catch{ return d } } };
      const hasData = (LS.get('reservations', []) || []).length > 0;
      if (!hasData && window.supabaseBridge?.syncAdminDataToLocal) {
        await window.supabaseBridge.syncAdminDataToLocal();
        document.dispatchEvent(new Event('sb:admin-synced')); // ÙŠÙƒÙÙŠ Ø§Ù„Ø­Ø¯Ø« Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø¨Ø£Ù…Ø§Ù†
        /* ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…ÙƒØ±Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ */
        /* try { document.dispatchEvent(new Event('sb:admin-synced')); } catch(_){} */
      }
    } catch(e){}
  })();
</script>


  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø§Ù… + Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬/Ø²Ø± Esc -->
  <div id="appModalOverlay" class="app-modal-overlay">
    <div class="app-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header><h3 id="modalTitle">Ù†Ù…ÙˆØ°Ø¬</h3><button type="button" class="btn btn-ghost" id="modalCloseBtn">Ø¥ØºÙ„Ø§Ù‚</button></header>
      <div class="body" id="modalBody"></div>
      <div class="actions" id="modalActions"></div>
    </div>
  </div>
  <script>
    (function(){
      var ov=document.getElementById('appModalOverlay'); if(!ov) return;
      var btn=document.getElementById('modalCloseBtn');
      function safeHide(){ try{ hideModal(); }catch(_){ ov.style.display='none'; } }
      if(btn) btn.addEventListener('click', (e)=>{ e.preventDefault(); safeHide(); });
      ov.addEventListener('click', (e)=>{ if(e.target===ov){ safeHide(); } });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ safeHide(); } });
    })();
  </script>
</body>
</html>
